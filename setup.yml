---
- name: Install and configure a rippled validator
  hosts: all
  user: ubuntu
  sudo: true
  vars:
    validation_seed: false
    validation_public_key: false
  vars_files:
    - "validation-keys/{{validator_uuid}}"
    - vars/validators.yml
  tasks:
    - name: Install apt repo
      apt_repository: repo='deb http://mirrors.ripple.com/ubuntu/ trusty stable contrib'
    - name: Install apt repo key
      apt_key: url=http://mirrors.ripple.com/mirrors.ripple.com.gpg.key
    - name: Install rippled
      apt: update_cache=true name=rippled
    - name: Make rippled data directories
      file: state=directory owner=rippled group=rippled path=/srv/rippled/db/
    - name: Configure rippled
      template: src=rippled.cfg dest=/etc/rippled/rippled.cfg
      notify:
        - Restart rippled
    - name: Start rippled
      service: name=rippled state=started
    - name: Wait for rippled to become available
      wait_for: port=51234
      when: "not validation_seed"
    - name: Generate a validator key
      shell: rippled --conf /etc/rippled/rippled.cfg -q validation_create > /tmp/validation_key
      when: "not validation_seed"
    - name: Install jq
      apt: name=jq
      when: "not validation_seed"
    - name: Extract public key
      command: jq -r .result.validation_public_key /tmp/validation_key
      register: validation_public_key_capture
      when: "not validation_public_key"
    - name: Extract public key
      command: jq -r .result.validation_seed /tmp/validation_key
      register: validation_seed_capture
      when: "not validation_seed"
    - name: Set validation seed vars
      set_fact: validation_seed={{validation_seed_capture.stdout}}
      when: "not validation_seed"
      notify:
        - Reinstall rippled.cfg with validator key
    - name: Set validation key var
      set_fact: validation_public_key={{validation_public_key_capture.stdout}}
      when: "not validation_public_key"
      notify:
        - Reinstall rippled.cfg with validator key
  handlers:
    - name: Reinstall rippled.cfg with validator key
      template: src=rippled.cfg dest=/etc/rippled/rippled.cfg
      notify: Restart rippled
    - name: Restart rippled
      service: name=rippled state=restarted
